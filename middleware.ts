// import { NextRequest, NextResponse } from "next/server";
// import { cookies } from "next/headers";
// import { refreshSession } from "./lib/api/serverApi";

// export async function middleware(req: NextRequest) {
//   const { pathname } = req.nextUrl;
//   const cookieStore = await cookies();
//   const accessToken = cookieStore.get("accessToken")?.value;
//   const refreshToken = cookieStore.get("refreshToken")?.value;

//   const isPublicPath =
//     pathname.startsWith("/sign-in") || pathname.startsWith("/sign-up");
//   const isPrivatePath =
//     pathname.startsWith("/profile") || pathname.startsWith("/notes");

//   const response = NextResponse.next();

//   if (!accessToken && refreshToken) {
//     try {
//       const { data: newTokens } = await refreshSession();

//       if (newTokens.accessToken && newTokens.refreshToken) {
//         response.cookies.set("accessToken", newTokens.accessToken, {
//           httpOnly: true,
//           sameSite: "lax",
//           secure: process.env.NODE_ENV === "production",
//           path: "/",
//         });
//         response.cookies.set("refreshToken", newTokens.refreshToken, {
//           httpOnly: true,
//           sameSite: "lax",
//           secure: process.env.NODE_ENV === "production",
//           path: "/",
//         });
//       }
//     } catch {
//       response.cookies.delete("accessToken");
//       response.cookies.delete("refreshToken");
//     }
//   }

//   if (!accessToken && isPrivatePath) {
//     const url = req.nextUrl.clone();
//     url.pathname = "/sign-in";
//     return NextResponse.redirect(url);
//   }

//   if (accessToken && isPublicPath) {
//     const url = req.nextUrl.clone();
//     url.pathname = "/";
//     return NextResponse.redirect(url);
//   }

//   return response;
// }

// export const config = {
//   matcher: ["/profile/:path*", "/notes/:path*", "/sign-in", "/sign-up"],
// };

/////////////////////////////////////////////////////////////////

// middleware.ts
import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";
import { refreshSession } from "./lib/api/serverApi";

export async function middleware(req: NextRequest) {
  const { pathname } = req.nextUrl;

  const isPublicPath =
    pathname.startsWith("/sign-in") || pathname.startsWith("/sign-up");
  const isPrivatePath =
    pathname.startsWith("/profile") || pathname.startsWith("/notes");

  // --- –æ—Ç—Ä–∏–º—É—î–º–æ —Ç–æ–∫–µ–Ω–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ ---
  const accessToken = req.cookies.get("accessToken")?.value ?? null;
  const refreshToken = req.cookies.get("refreshToken")?.value ?? null;

  let token = accessToken;

  console.log("middleware tokens:", { accessToken, refreshToken, pathname });

  // --- –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤ —á–µ—Ä–µ–∑ refreshToken ---
  if (!accessToken && refreshToken) {
    try {
      const newTokens = await refreshSession();

      if (newTokens?.accessToken && newTokens?.refreshToken) {
        token = newTokens.accessToken;
        const res = NextResponse.next();
        res.cookies.set("accessToken", newTokens.accessToken, {
          httpOnly: true,
          sameSite: "lax",
          secure: process.env.NODE_ENV === "production",
          path: "/",
        });
        res.cookies.set("refreshToken", newTokens.refreshToken, {
          httpOnly: true,
          sameSite: "lax",
          secure: process.env.NODE_ENV === "production",
          path: "/",
        });
        return res;
      } else {
        const url = req.nextUrl.clone();
        url.pathname = "/sign-in";
        const res = NextResponse.redirect(url);
        res.cookies.delete("accessToken");
        res.cookies.delete("refreshToken");
        return res;
      }
    } catch {
      const url = req.nextUrl.clone();
      url.pathname = "/sign-in";
      const res = NextResponse.redirect(url);
      res.cookies.delete("accessToken");
      res.cookies.delete("refreshToken");
      return res;
    }
  }

  // --- —Ä–µ–¥—ñ—Ä–µ–∫—Ç –Ω–∞ /sign-in –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–∏—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ ---
  if (!token && isPrivatePath) {
    const url = req.nextUrl.clone();
    url.pathname = "/sign-in";
    return NextResponse.redirect(url);
  }

  // --- —Ä–µ–¥—ñ—Ä–µ–∫—Ç –Ω–∞ /profile –¥–ª—è –ø—É–±–ª—ñ—á–Ω–∏—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤, —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞–ª–æ–≥—ñ–Ω–µ–Ω–∏–π ---
  if (token && isPublicPath) {
    const url = req.nextUrl.clone();
    url.pathname = "/profile";
    return NextResponse.redirect(url);
  }

  return NextResponse.next();
}

export const config = {
  matcher: ["/profile/:path*", "/notes/:path*", "/sign-in", "/sign-up"],
};

////////////////////////////////////////////////////////////////

// middleware.ts
// import { NextRequest, NextResponse } from "next/server";
// import { refreshSession } from "./lib/api/serverApi"; // üëà —ñ–º–ø–æ—Ä—Ç—É—î–º–æ –¥–µ—Ñ–æ–ª—Ç–Ω–∏–π export

// export async function middleware(req: NextRequest) {
//   const { pathname } = req.nextUrl;

//   const isPublicPath =
//     pathname.startsWith("/sign-in") || pathname.startsWith("/sign-up");
//   const isPrivatePath =
//     pathname.startsWith("/profile") || pathname.startsWith("/notes");

//   const accessToken = req.cookies.get("accessToken")?.value ?? null;
//   const refreshToken = req.cookies.get("refreshToken")?.value ?? null;

//   let token = accessToken;

//   console.log(
//     "token in middleware:",
//     token,
//     "refreshToken:",
//     refreshToken,
//     "pathname:",
//     pathname,
//   );

//   // --- –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–æ–∫–µ–Ω—ñ–≤ —á–µ—Ä–µ–∑ refreshToken ---
//   if (!accessToken && refreshToken) {
//     try {
//       const { data: newTokens } = await refreshSession(); // üëà —Ç–µ–ø–µ—Ä –ø–æ–≤–µ—Ä—Ç–∞—î –æ–¥—Ä–∞–∑—É —Ç–æ–∫–µ–Ω–∏
//       if (newTokens?.accessToken && newTokens?.refreshToken) {
//         token = newTokens.accessToken;

//         const res = NextResponse.next();
//         res.cookies.set("accessToken", newTokens.accessToken, {
//           httpOnly: true,
//           sameSite: "lax",
//           secure: process.env.NODE_ENV === "production",
//           path: "/",
//         });
//         res.cookies.set("refreshToken", newTokens.refreshToken, {
//           httpOnly: true,
//           sameSite: "lax",
//           secure: process.env.NODE_ENV === "production",
//           path: "/",
//         });
//         return res;
//       } else {
//         // refreshSession –Ω–µ –ø–æ–≤–µ—Ä–Ω—É–≤ —Ç–æ–∫–µ–Ω–∏ ‚Üí –≤–∏–¥–∞–ª—è—î–º–æ —ñ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º–æ –Ω–∞ sign-in
//         const url = req.nextUrl.clone();
//         url.pathname = "/sign-in";
//         const res = NextResponse.redirect(url);
//         res.cookies.delete("accessToken");
//         res.cookies.delete("refreshToken");
//         return res;
//       }
//     } catch {
//       const url = req.nextUrl.clone();
//       url.pathname = "/sign-in";
//       const res = NextResponse.redirect(url);
//       res.cookies.delete("accessToken");
//       res.cookies.delete("refreshToken");
//       return res;
//     }
//   }

//   // --- –†–µ–¥—ñ—Ä–µ–∫—Ç –Ω–∞ /sign-in –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–∏—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤ –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ ---
//   if (!token && isPrivatePath) {
//     const url = req.nextUrl.clone();
//     url.pathname = "/sign-in";
//     return NextResponse.redirect(url);
//   }

//   // --- –†–µ–¥—ñ—Ä–µ–∫—Ç –Ω–∞ /profile –¥–ª—è –ø—É–±–ª—ñ—á–Ω–∏—Ö –º–∞—Ä—à—Ä—É—Ç—ñ–≤, —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞–ª–æ–≥—ñ–Ω–µ–Ω–∏–π ---
//   if (token && isPublicPath) {
//     const url = req.nextUrl.clone();
//     url.pathname = "/profile";
//     return NextResponse.redirect(url);
//   }

//   return NextResponse.next();
// }

// export const config = {
//   matcher: ["/profile/:path*", "/notes/:path*", "/sign-in", "/sign-up"],
// };
